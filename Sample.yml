name: Loop workflow

on:
  push:
    branches:
      - main  # Or specify the branch you want to trigger this workflow

jobs:
  sync-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source code
        uses: actions/checkout@v2

      - name: Install Python and pip
        run: |
          sudo apt update
          sudo apt install -y python3 python3-pip

      - name: Install PyNaCl
        run: |
          sudo pip install pynacl

      - name: Retrieve environment secrets
        run: |
          # Retrieve the list of environment secrets
          secrets=$(curl --location --request GET \
          'https://api.github.com/repos/neeratikrishna15/databricksencryption/actions/secrets' \
          --header 'Authorization: Bearer ${{ secrets.TOKEN }}' | jq -r '.secrets[].name')

          # Loop through each environment secret
          for secret_name in $secrets; do
            # Retrieve the value of the environment secret
            secret_value=$(curl --location --request GET \
            "https://api.github.com/repos/neeratikrishna15/databricksencryption/actions/secrets/$secret_name" \
            --header 'Authorization: Bearer ${{ secrets.TOKEN }}' | jq -r '.encrypted_value')

            # Create a similar environment in the destination repository
            curl --location --request PUT \
            "https://api.github.com/repos/neeratikrishna15/dev-environment/environments/$secret_name" \
            --header 'Authorization: Bearer ${{ secrets.TOKEN }}' \
            --header 'Content-Type: application/json' \
            --data-raw "{\"name\":\"$secret_name\"}"

            # Copy the secret to the corresponding environment in the destination repository
            curl --location --request PUT \
            "https://api.github.com/repos/neeratikrishna15/dev-environment/actions/secrets/$secret_name" \
            --header 'Authorization: Bearer ${{ secrets.TOKEN }}' \
            --header 'Content-Type: application/json' \
            --data-raw "{\"encrypted_value\":\"$secret_value\",\"key_id\":\"3380204578043523366\"}"
          done
